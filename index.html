<!DOCTYPE>
<html>
<head>
<title>Lamudi Exam CRUD Rest API</title>
<!-- Latest compiled and minified CSS -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
<style>
	.main__container {
		margin: 0 auto;
		width: 1000px;
	}
	.main__container table tr td {
		width: calc(100%/7);
	}
	.main__container table .btn {
		width: 100%;
	}
	
	/*==  added ==*/
	.btn-save, 
	.btn-cancel {
		display: none;
	}
</style>
<!-- jQuery library -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<!-- Latest compiled JavaScript -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
<!-- jQuery Validator -->
<script src="assets/js/jquery.validate.min.js"></script>
<script>
	$(document).ready(function(){
		
		var detach = '';
		
		// submit form data to api
		$.fn.serializeObject = function() {
			var o = {};
			var a = this.serializeArray();
			$.each(a, function() {
				if (o[this.name]) {
					if (!o[this.name].push) {
						o[this.name] = [o[this.name]];
					}
					o[this.name].push(this.value || '');
				} else {
					o[this.name] = this.value || '';
				}
			});
			return o;
		};		
		
		// convert to html data
		$.get__data_html = function(user_id, first_name, last_name, email_address, phone_number, date_added) {
			var html = '';
			
			html += '<tr data-id="' + user_id + '">';
				html += '<td>';
					html += '<span class="row-data" data-name="first_name">' + first_name + '</span>';
				html += '</td>';
			
				html += '<td>';
					html += '<span class="row-data" data-name="last_name">' + last_name + '</span>';
				html += '</td>';
			
				html += '<td>';
					html += '<span class="row-data" data-name="email_address">' + email_address + '</span>';
				html += '</td>';
			
				html += '<td>';
					html += '<span class="row-data" data-name="phone_number">' + phone_number + '</span>';
				html += '</td>';
			
				html += '<td>';
					html += '<input type="button" class="btn btn-default btn-upd" data-id="' + user_id + '" value="Edit">';
					
					html += '<span class="btn-save"> <a href="#" class="btn btn-link"  data-id="' + user_id + '"> Save</a> | </span>';
					html += '<span class="btn-cancel"> <a href="#" class="btn btn-link" data-id="' + user_id + '"> Cancel</a> | </span>';
					
				html += '</td>';
			
				html += '<td>';
					html += '<input type="button" id="del" class="btn btn-danger btn-del" data-id="' + user_id + '" value="Delete">';
				html += '</td>';
			
			html += '</tr>';
			
			return html;
		}

		// added
		
		// for getting the data 
		$.get__data_init = function(detach__header) {
			
			// for detach
			if (detach__header) {
				$('.registered__users table tbody').html(detach);
			}
			
			$.ajax({
				url: "http://localhost/exam_lamudi/userinput/read.php",
				contentType : "application/json",
				dataType: "json",
				success: function(result) {				
					$.each(result.reg_users, function(k, v) {
						var user_id 	= v.user_id,
							first_name  = v.first_name,
							last_name   = v.last_name,
							email_address = v.email_address,
							phone_number  = v.phone_number,
							date_added 	  = v.date_added;
						
						// call function to get data from json to html
						$('.registered__users table').append($.get__data_html(user_id, first_name, last_name, email_address, phone_number, date_added));
					});				
				},
				error: function(xhr, resp, text) {
					console.log(xhr, resp, text);
				}
			});
		}
		
		// for creating the data 		
		var validate = $('form').validate({
			submitHandler: function(form) {
				var form_data = JSON.stringify($('form').serializeObject());
				
				//console.log($(this).serialize());
				console.log(form_data);
				
				$.ajax({
					url: "http://localhost/exam_lamudi/userinput/create.php",
					contentType: "application/json",
					dataType: "json",
					type: "POST",
					data: form_data,
					success: function(result) {
						//detach header
						detach = $('.detach').detach();
						
						$('.registered__users table tbody').html('');
						$.get__data_init(true);
						$('form').get(0).reset();
						$('.alert').removeClass('alert-danger').addClass('alert-success').show().html('<strong>Note:</strong> User has been created.');
					},
					error: function(xhr, resp, text) {
						console.log(xhr, resp, text);
					}
				});
			}
		});
		
		// to cancel adding users
		$('.btn-can').click(function(e){
			e.preventDefault();
			validate.resetForm();
			$('form').get(0).reset();
		});

		
		// for updating the data
	    $(document).on('click', '.btn-upd', function() {
	        var tbl_row = $(this).closest('tr');
	        var data_id = tbl_row.attr('data-id');

	        tbl_row.find('.btn-save').show();
	        tbl_row.find('.btn-cancel').show();

	        //hide edit button
	        tbl_row.find('.btn-upd').hide();

	        //make the whole row editable
	        tbl_row.find('.row-data').attr('contenteditable', 'true').attr('data-edit', 'button').addClass('form-control');

	        tbl_row.find('.row-data').each(function(index, val) {
	            //this will help in case user decided to click on cancel button
	            $(this).attr('original-data', $(this).html());
	        });
	    });	
		
		// for cancel edit
		$(document).on('click', '.btn-cancel', function() {
	        var tbl_row = $(this).closest('tr');
	        var data_id = tbl_row.attr('data-id');

	        //hide save and cacel buttons
	        tbl_row.find('.btn-save').hide();
	        tbl_row.find('.btn-cancel').hide();

	        //show edit button
	        tbl_row.find('.btn-upd').show();

	        //make the whole row editable
	        tbl_row.find('.row-data').attr('data-edit', 'click').removeAttr('contenteditable').removeClass('form-control');

	        tbl_row.find('.row-data').each(function(index, val) {
	            $(this).html($(this).attr('original-data'));
	        });
	    });
		
		// to save edit
	    $(document).on('click', '.btn-save', function() {
	        var tbl_row = $(this).closest('tr');
	        var data_id = tbl_row.attr('data-id');

	        //hide save and cacel buttons
	        tbl_row.find('.btn-save').hide();
	        tbl_row.find('.btn-cancel').hide();

	        //show edit button
	        tbl_row.find('.btn-upd').show();

	        //make the whole row editable
	        tbl_row.find('.row-data').attr('data-edit', 'click').removeAttr('contenteditable').removeClass('form-control')
	            
	        var arr = {};
	        tbl_row.find('.row-data').each(function(index, val) {
	            var data_name = $(this).attr('data-name');
	            var data_val = $(this).html();
	            arr[data_name] = data_val;
	        });
			
	        // user-id for ajax call
	        $.extend(arr, {
	            user_id: data_id
	        });
			
			$.ajax({
				url: "http://localhost/exam_lamudi/userinput/update.php",
				contentType: "application/json",
				dataType: "json",
				type: "PUT",
				data: JSON.stringify(arr),
				success: function(result) {
					console.log(result);
					$('.alert').removeClass('alert-danger').addClass('alert-success').show().html('<strong>Note:</strong> User has beeen updated.')
				},
				error: function(xhr, resp, text) {
					console.log(xhr, resp, text);
				}
			});			
	    });		
		
		// for deleting the data
		$(document).on('click', '.btn-del', function() {
			console.log($(this).attr('data-id'));
			$(this).parents('tr').remove();
			
			$.ajax({
				url: 'http://localhost/exam_lamudi/userinput/delete.php?' + $.param({ "user_id": $(this).attr('data-id') }),
				type: 'DELETE',
				success: function(result){
					console.log(result);
					$('.alert').removeClass('alert-success').addClass('alert-danger').show().html('<strong>Note:</strong> User Deleted.')
				},
				error: function(xhr, resp, text) {
					console.log(xhr, resp, text);
				}
			});		
			
		});		
		
		// initialize data first
		$.get__data_init(false);
	});
</script>
</head>
<body>
	<div class="main__container">
		<div class="registered__users">
			<form method="post" action="#" class="form__submit" autocomplete="off">
				<table class="table table-hover">
					<tr class="detach">
						<th>
							First Name
						</th>
						<th>
							Last Name
						</th>
						<th>
							Email Address
						</th>
						<th>
							Phone Number
						</th>
						<th colspan="2">
							
						</th>
					</tr>
					<tr class="detach">
						<td>
							<input type="text" name="first_name" class="form-control required" id="first_name" placeholder="First Name">
						</td>
						<td>
							<input type="text" name="last_name" class="form-control required" id="last_name" placeholder="Last Name">
						</td>
						<td>
							<input type="text" name="email_address" class="form-control required" id="email_address" placeholder="Email Address">
						</td>
						<td>
							<input type="text" name="phone_number" class="form-control required" id="phone_number" placeholder="Phone Number">
						</td>
						<td>
							<button type="submit" class="btn btn-default">Add</button>
						</td>
						<td>
							<button type="button" class="btn btn-default btn-can">Cancel</button>
						</td>
					</tr>
				</table>
			</form>
			
		</div>
		
		<!-- for message alert -->
		<div style="display: none;" class="alert"></div>
		<!-- for message alert -->
	</div>
	
</body>
</html>